var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},GameOther=function(t){function e(){var e=t.call(this)||this;return e.addGameBg(),e.addGameName(),e.addGameSlogan(),e.addHowToPlay(),e.addCopyRight(),e}return __extends(e,t),e.prototype.addGameName=function(){var t=new egret.TextField;t.text="2048",t.size=56,t.textColor=Main.FONT_COLOR,t.fontFamily=Main.FONT_FAMILY,t.bold=!0,t.height=80,t.verticalAlign=egret.VerticalAlign.BOTTOM,t.x=Main.paddingLeft,t.y=Main.paddingTop,this.addChild(t)},e.prototype.addGameBg=function(){var t=new egret.Shape;t.graphics.beginFill(Main.GAME_BG_COLOR),t.graphics.drawRect(0,0,Main.stageW,Main.stageH),t.graphics.endFill(),this.addChild(t)},e.prototype.addGameSlogan=function(){var t=new egret.TextField;t.text="叠加数字，以最快速度达到2048吧！",t.size=24,t.width=264,t.lineSpacing=10,t.textColor=Main.FONT_COLOR,t.fontFamily=Main.FONT_FAMILY,t.x=Main.paddingLeft,t.y=176,this.addChild(t)},e.prototype.addHowToPlay=function(){var t=new egret.TextField,e=new egret.TextField;t.text="玩法：使用方向键/滑动的方式去移动砖块，当两块数值相同的方块发生碰撞，将会合成一块。",e.text="PS：方向键可以是↑↓←→ 或 WSAD。",t.x=e.x=Main.paddingLeft,t.y=926,e.y=1014,t.size=e.size=24,t.lineSpacing=e.lineSpacing=10,t.textColor=e.textColor=Main.FONT_COLOR,t.width=e.width=Main.stageW-2*Main.paddingLeft,this.addChild(t),this.addChild(e)},e.prototype.addCopyRight=function(){var t=new egret.TextField;t.textFlow=(new egret.HtmlTextParser).parser("Designed & Developed by <u><a href = 'https://github.com/JChehe'>J.c</a></u>"),t.touchEnabled=!0,t.addEventListener(egret.TextEvent.LINK,function(t){console.log(t.text),window.open("https://github.com/JChehe")},this),t.width=Main.stageW,t.textAlign=egret.HorizontalAlign.CENTER,t.size=24,t.textColor=Main.FONT_COLOR,t.y=Main.stageH-56,this.addChild(t)},e}(egret.DisplayObjectContainer);__reflect(GameOther.prototype,"GameOther");var GameOverDialog=function(t){function e(){var e=t.call(this)||this;return e.restartBtn=new RestartBtn(254,846,"再玩一次"),e.x=0,e.y=0,e.width=Main.stageW,e.height=Main.stageH,e.addMask(),e.addChild(e.restartBtn),e.addText(),e.addCry(),e}return __extends(e,t),e.prototype.triggerMaskTap=function(){this.dispatchEventWith(egret.TouchEvent.TOUCH_TAP)},e.prototype.addMask=function(){var t=new egret.Shape;this.maskDisplayObject=t,t.graphics.beginFill(16777215,.8),t.graphics.drawRect(0,0,Main.stageW,Main.stageH),t.graphics.endFill(),this.touchEnabled=!0,this.restartBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.stopRestartBtnPropagation,this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onMaskTouchTap,this,!1),this.addChild(t)},e.prototype.stopRestartBtnPropagation=function(t){t.stopPropagation()},e.prototype.onMaskTouchTap=function(t){console.log("mask 被触发啦"),this.parent&&(this.parent.removeChild(this),Main.instance.setGameOverDialogNull())},e.prototype.addText=function(){var t=new egret.TextField;t.text="Game Over !",t.size=96,t.textColor=Main.FONT_COLOR,t.width=Main.stageW,t.textAlign=egret.HorizontalAlign.CENTER,t.y=332,t.rotation=-6,this.addChild(t)},e.prototype.addCry=function(){var t=new egret.Bitmap;t.texture=RES.getRes("cry_png"),t.width=202,t.height=202,t.y=452,t.x=276,this.addChild(t)},e}(egret.DisplayObjectContainer);__reflect(GameOverDialog.prototype,"GameOverDialog");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var RestartBtn=function(t){function e(e,i,o){void 0===o&&(o="New Game");var r=t.call(this)||this;return r._x=e,r._y=i,r.text=o,r.BG_COLOR=10736860,r.FONT_COLOR=16777215,r._width=238,r._height=80,r._radius=6,r.x=r._x,r.y=r._y,r.addBg(),r.addText(),r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,r.onTouchTap,r,!1),r.addEventListener(RestartEvent.NAME,r.restartHandle,r),r}return __extends(e,t),e.prototype.restartHandle=function(){Main.instance.restart(),console.log("触发game restart")},e.prototype.addBg=function(){var t=new egret.Shape;t.graphics.beginFill(this.BG_COLOR),t.graphics.drawRoundRect(0,0,this._width,this._height,this._radius),t.graphics.endFill(),this.addChild(t)},e.prototype.addText=function(){var t=new egret.TextField;t.text=this.text,t.size=30,t.textColor=this.FONT_COLOR,t.width=this._width,t.height=this._height,t.textAlign=egret.HorizontalAlign.CENTER,t.verticalAlign=egret.VerticalAlign.MIDDLE,this.addChild(t)},e.prototype.onTouchTap=function(){console.log(this);var t=new RestartEvent(RestartEvent.NAME);this.dispatchEvent(t)},e}(egret.DisplayObjectContainer);__reflect(RestartBtn.prototype,"RestartBtn");var RoundRect=function(t){function e(e,i,o,r){void 0===e&&(e=0),void 0===i&&(i=0);var n=t.call(this)||this;return n._x=e,n._y=i,n._title=o,n._content=r,n._bg_color=10736860,n._min_Width=120,n._height=110,n._radius=6,n.x=n._x,n.y=n._y,n.addBg(),n.addTitle(),n.addContent(),n}return __extends(e,t),e.prototype.addBg=function(){var t=new egret.Shape;t.graphics.beginFill(this._bg_color),t.graphics.drawRoundRect(0,0,this._min_Width,this._height,this._radius),t.graphics.endFill(),this.addChild(t)},e.prototype.addTitle=function(){var t=new egret.TextField;t.text=this._title,t.size=24,t.textColor=Main.FONT_COLOR,t.width=this._min_Width,t.height=34,t.y=12,t.textAlign=egret.HorizontalAlign.CENTER,this.addChild(t)},e.prototype.addContent=function(){var t=new egret.TextField;t.name="content",t.text=this._content.toString(),t.size=50,t.textColor=16777215,console.log("content.measuredWidth",t.measuredWidth),t.width=Math.max(t.measuredWidth,this._min_Width),t.height=72,t.y=36,t.textAlign=egret.HorizontalAlign.CENTER,t.verticalAlign=egret.VerticalAlign.MIDDLE,this.addChild(t)},e.prototype.restart=function(){console.log("被触发啦"),this._content=Main.score=0,this.removeChild(this.getChildByName("content")),this.addContent()},e.prototype.setContent=function(t){this.removeChild(this.getChildByName("content")),this._content=t,this.addContent()},e.prototype.getContent=function(){return this._content},e}(egret.DisplayObjectContainer);__reflect(RoundRect.prototype,"RoundRect");var GameOverEvent=function(t){function e(e,i,o){return void 0===i&&(i=!1),void 0===o&&(o=!1),t.call(this,e,i,o)||this}return __extends(e,t),e}(egret.Event);GameOverEvent.NAME="游戏结束",__reflect(GameOverEvent.prototype,"GameOverEvent");var RestartEvent=function(t){function e(e,i,o){return void 0===i&&(i=!1),void 0===o&&(o=!1),t.call(this,e,i,o)||this}return __extends(e,t),e}(egret.Event);RestartEvent.NAME="重新开始",__reflect(RestartEvent.prototype,"RestartEvent");var Game=function(t){function e(){var i=t.call(this)||this;return i._x=Main.paddingLeft,i._y=300,i._sideLength=564,i._gridAmount=16,i._gridSpacing=20,i._gridRadius=12,i._mainBgRadius=16,i._row=4,i._col=4,i._gridBgColor=15656154,i._mainBgColor=9624306,i._gridWidth=(i._sideLength-(i._col+1)*i._gridSpacing)/i._col,i._gridHeight=(i._sideLength-(i._row+1)*i._gridSpacing)/i._row,i._gridsDisplayContainer=new egret.DisplayObjectContainer,i._gridInfo=[{num:2,color:7827045,backgroundColor:15656154,fontSize:65},{num:4,color:7827045,backgroundColor:15589576,fontSize:65},{num:8,color:16381682,backgroundColor:15905145,fontSize:55},{num:16,color:16381682,backgroundColor:16094563,fontSize:55},{num:32,color:16381682,backgroundColor:16153695,fontSize:55},{num:64,color:16381682,backgroundColor:16145979,fontSize:55},{num:128,color:16381682,backgroundColor:15585138,fontSize:45},{num:256,color:16381682,backgroundColor:15584353,fontSize:45},{num:512,color:16381682,backgroundColor:15583312,fontSize:45},{num:1024,color:16381682,backgroundColor:11264856,fontSize:35},{num:2048,color:16381682,backgroundColor:5102031,fontSize:35},{num:4096,color:16381682,backgroundColor:10650617,fontSize:35},{num:8192,color:16381682,backgroundColor:16352131,fontSize:35}],i._addGridAmount=2,i._grids=[],e.instance=i,i.x=i._x,i.y=i._y,i.addMainBg(),i.addGridBg(),document.addEventListener("keyup",e.onKeyup,!1),i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onGameTouchBegin,i),i.initGrids(),i.addGrids(),i.addChild(i._gridsDisplayContainer),i.drawGrids(),i}return __extends(e,t),e.prototype.restart=function(){console.log("game restart"),Main.isGameOver=!1,this.initGrids(),this._gridsDisplayContainer.removeChildren(),this.addGrids(),this.drawGrids()},e.prototype.initGrids=function(){for(var t=0;t<this._row;t++){this._grids[t]=[];for(var e=0;e<this._col;e++)this._grids[t][e]=0}},e.prototype.drawGrid=function(t,e,i){var o=t*this._col+e,r=this.getLeftByIndex(o),n=this.getTopByIndex(o),a=this.getGridInfoByNum(i),s=new egret.Sprite;s.name="grid-"+t+"-"+e,s.x=r,s.y=n,s.graphics.beginFill(a.backgroundColor,1),s.graphics.drawRoundRect(0,0,this._gridWidth,this._gridWidth,this._gridRadius),s.graphics.endFill();var d=new egret.TextField;d.text=i,d.width=this._gridWidth,d.height=this._gridHeight,d.size=a.fontSize,d.textColor=a.color,d.textAlign=egret.HorizontalAlign.CENTER,d.verticalAlign=egret.VerticalAlign.MIDDLE,s.addChild(d),this._gridsDisplayContainer.addChild(s)},e.prototype.moveToLeft=function(){console.log("left");for(var t=!1,e=this._grids,i={},o=0,r=0;r<this._row;r++)for(var n=1;n<this._col;n++)console.log("_grids["+r+"]["+(n-1)+"]",e[r][n-1]),0!==e[r][n]&&(0===e[r][n-1]?(e[r][n-1]=e[r][n],e[r][n]=0,n=0,t=!0):e[r][n-1]!==e[r][n]||i[""+r+(n-1)]||i[""+r+n]||(o=e[r][n-1]*=2,e[r][n]=0,i[""+r+(n-1)]=!0,n=0,t=!0));console.log("mergeTags",i),i=null,this.afterMoving(t,o)},e.prototype.moveToRight=function(){console.log("right");for(var t=!1,e=this._grids,i={},o=0,r=0;r<this._row;r++)for(var n=this._col-2;n>=0;n--)0!==e[r][n]&&(0===e[r][n+1]?(e[r][n+1]=e[r][n],e[r][n]=0,n=this._col-1,t=!0):e[r][n+1]!==e[r][n]||i[""+r+(n+1)]||i[""+r+n]||(o=e[r][n+1]*=2,e[r][n]=0,i[""+r+(n+1)]=!0,n=this._col-1,t=!0));i=null,this.afterMoving(t,o)},e.prototype.moveUp=function(){console.log("up");for(var t=!1,e=this._grids,i={},o=0,r=0;r<this._col;r++)for(var n=1;n<this._row;n++)0!==e[n][r]&&(0===e[n-1][r]?(e[n-1][r]=e[n][r],e[n][r]=0,n=0,t=!0):e[n-1][r]!==e[n][r]||i[""+(n-1)+r]||i[""+n+r]||(o=e[n-1][r]*=2,e[n][r]=0,i[""+(n-1)+r]=!0,n=0,t=!0));console.log("mergeTags",i),i=null,this.afterMoving(t,o)},e.prototype.moveDown=function(){console.log("down");for(var t=!1,e=this._grids,i={},o=0,r=0;r<this._col;r++)for(var n=this._row-2;n>=0;n--)0!==e[n][r]&&(0===e[n+1][r]?(e[n+1][r]=e[n][r],e[n][r]=0,n=this._row-1,t=!0):e[n+1][r]!==e[n][r]||i[""+(n+1)+r]||i[""+n+r]||(o=e[n+1][r]*=2,e[n][r]=0,i[""+(n+1)+r]=!0,n=this._row-1,t=!0));console.log("mergeTags",i),i=null,this.afterMoving(t,o)},e.prototype.afterMoving=function(t,e){void 0===e&&(e=0),this.checkGameOver()?this.gameOverHandle():t&&(this.updateScore(e),this.addGrids(),console.log("isMove"),this.drawGrids())},e.prototype.getGridInfoByNum=function(t){var e;return this._gridInfo.forEach(function(i){i.num===t&&(e=i)}),e||this._gridInfo[this._gridInfo.length-1]},e.prototype.checkGameOver=function(){for(var t=this._grids,e=!0,i=0;i<this._row;i++){for(var o=0;o<this._col;o++){var r=t[i][o];if(0===r||i>0&&r===t[i-1][o]||o>0&&r===t[i][o-1]||i<this._col-1&&r===t[i+1][o]||o>this._row-1&&r===t[i][o+1]){e=!1;break}}if(!e)break}return e},e.prototype.updateScore=function(t){Main.instance.updateScore(t)},e.prototype.gameOverHandle=function(){var t=this;console.log("isGameOver"),Main.isGameOver=!0;var e=new GameOverEvent(GameOverEvent.NAME);setTimeout(function(){t.stage.dispatchEvent(e)},400)},e.prototype.addGrids=function(){for(var t=[],e=0;e<this._row;e++)for(var i=0;i<this._col;i++)0===this._grids[e][i]&&t.push({x:e,y:i});for(var o=Math.min(this._addGridAmount,t.length),r=[],e=0;o>e;e++){var n=this.getRandomInt(0,t.length-1);r.push(t[n]),t.splice(n,1)}for(var e=0;e<r.length;e++){var a=r[e].x,s=r[e].y;this._grids[a][s]=this.getNewNumber()}},e.prototype.drawGrids=function(){this._gridsDisplayContainer.removeChildren();for(var t=0;t<this._row;t++)for(var e=0;e<this._col;e++)0!==this._grids[t][e]&&this.drawGrid(t,e,this._grids[t][e])},e.prototype.getRandomInt=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},e.prototype.getNewNumber=function(){var t=Math.random();return.9>t?2:4},e.prototype.addMainBg=function(){var t=new egret.Shape;t.graphics.beginFill(this._mainBgColor),t.graphics.drawRoundRect(0,0,this._sideLength,this._sideLength,this._mainBgRadius),t.$graphics.endFill(),this.addChild(t)},e.prototype.addGridBg=function(){for(var t=0;t<this._gridAmount;t++){var e=this.getLeftByIndex(t),i=this.getTopByIndex(t),o=new egret.Shape;o.graphics.beginFill(this._gridBgColor,.35),o.graphics.drawRoundRect(e,i,this._gridWidth,this._gridHeight,this._gridRadius),o.graphics.endFill(),this.addChild(o)}},e.prototype.getRowByIndex=function(t){return Math.floor(t/this._col)},e.prototype.getColByIndex=function(t){return t%this._row},e.prototype.getLeftByIndex=function(t){var e=this.getColByIndex(t);return(e+1)*this._gridSpacing+e*this._gridWidth},e.prototype.getTopByIndex=function(t){var e=this.getRowByIndex(t);return(e+1)*this._gridSpacing+e*this._gridWidth},e.prototype.onGameTouchBegin=function(t){if(!Main.isGameOver){var e=t.currentTarget;e.touchX=t.stageX,e.touchY=t.stageY,this.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onGameTouchMove,this)}},e.prototype.onGameTouchMove=function(t){var e=t.currentTarget,i=t.stageX-e.touchX,o=t.stageY-e.touchY;Math.abs(i-o)<=40||(Math.abs(i)>Math.abs(o)?0>i?this.moveToLeft():this.moveToRight():0>o?this.moveUp():this.moveDown(),this.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onGameTouchMove,this))},e.onKeyup=function(t){if(!Main.isGameOver){var i=t.key;switch(i){case"a":case"A":case"ArrowLeft":e.instance.moveToLeft();break;case"d":case"D":case"ArrowRight":e.instance.moveToRight();break;case"w":case"W":case"ArrowUp":e.instance.moveUp();break;case"s":case"S":case"ArrowDown":e.instance.moveDown()}}},e}(egret.DisplayObjectContainer);__reflect(Game.prototype,"Game");var Main=function(t){function e(){var i=t.call(this)||this;return e.instance=i,i.addEventListener(egret.Event.ADDED_TO_STAGE,i.onAddToStage,i),i}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){var e=this;if("preload"==t.groupName){var i=0;setTimeout(function(){e.stage.removeChild(e.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,e.onResourceLoadComplete,e),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,e.onResourceLoadError,e),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,e.onResourceProgress,e),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,e.onItemLoadError,e),e.createGameScene()},i)}},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){e.stageW=this.stage.stageWidth,e.stageH=this.stage.stageHeight,this.gameOther=new GameOther,this.stage.addChild(this.gameOther),this.scorePanel=new RoundRect(398,e.paddingTop,"SCORE",0),this.stage.addChild(this.scorePanel);var t=JSON.parse(egret.localStorage.getItem("best"));(void 0===t||null===t)&&(t=0),this.bestPanel=new RoundRect(538,e.paddingTop,"BEST",t),this.stage.addChild(this.bestPanel),this.restartBtn=new RestartBtn(420,170),this.stage.addChild(this.restartBtn),this.game=new Game,this.stage.addChild(this.game),this.stage.addEventListener(GameOverEvent.NAME,this.gameOverHandle,this),e.isGameOver&&(this.gameOverDialog=new GameOverDialog,this.stage.addChild(this.gameOverDialog))},e.prototype.restart=function(){this.scorePanel.restart(),this.game.restart(),this.gameOverDialog&&this.gameOverDialog.triggerMaskTap(),console.log("触发game restart")},e.prototype.gameOverHandle=function(){console.log("Game Over Event"),this.gameOverDialog||(this.gameOverDialog=new GameOverDialog,this.stage.addChild(this.gameOverDialog))},e.prototype.setGameOverDialogNull=function(){this.gameOverDialog=null},e.prototype.updateScore=function(t){e.score+=t,e.score>this.bestPanel.getContent()&&(this.bestPanel.setContent(e.score),egret.localStorage.setItem("best",e.score.toString())),this.scorePanel.setContent(e.score)},e}(egret.DisplayObjectContainer);Main.GAME_BG_COLOR=9301203,Main.FONT_COLOR=6272174,Main.FONT_FAMILY="PingFang SC",Main.stageW=0,Main.stageH=0,Main.paddingTop=40,Main.paddingLeft=94,Main.score=0,Main.best=0,Main.isGameOver=!1,__reflect(Main.prototype,"Main");